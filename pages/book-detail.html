<!DOCTYPE html>
<html lang="ko" data-theme="heritage">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>êµí™˜ë…ì„œ â€“ ì±… ìƒì„¸</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .detail-wrap{display:grid;gap:1.25rem;grid-template-columns: 1fr;}
    @media(min-width:900px){.detail-wrap{grid-template-columns: 320px 1fr}}
    .cover{aspect-ratio:2/3;border:1px solid var(--line);border-radius:.8rem;background:linear-gradient(135deg, color-mix(in oklab,var(--accent) 30%, var(--paper)), var(--paper));display:grid;place-items:center;box-shadow:0 2px 0 rgba(0,0,0,.04),0 12px 28px rgba(0,0,0,.08)}
    .cover img{width:100%;height:100%;object-fit:cover;border-radius:.8rem}
    .cover .placeholder{font-family:'Nanum Myeongjo',serif;color:#000a;font-size:1.1rem;text-align:center;padding:1rem}
    .meta{display:grid;gap:.4rem}
    .rating{display:flex;align-items:center;gap:.5rem}
    .stars{--size:22px;display:inline-flex;gap:2px}
    .star{width:var(--size);height:var(--size);fill:gold;filter:drop-shadow(0 1px 0 rgba(0,0,0,.12))}
    .star.empty{fill:#ccc}
    .star.half{fill:gold}
    .pill{display:inline-flex;align-items:center;gap:.25rem;margin-right:.35rem}
    .review-form{display:grid;gap:.5rem;margin-top:1rem}
    .review-form textarea{min-height:88px;resize:vertical;padding:.6rem;border-radius:.6rem;border:1px solid var(--line)}
    .review{border-top:1px solid var(--line);padding:.75rem 0}
    .review .who{font-weight:700;margin-right:.4rem}
    
    /* ë‹µê¸€ ìŠ¤íƒ€ì¼ */
    .replies{margin-left:1.5rem;margin-top:.8rem;margin-bottom:.6rem;padding:.6rem .8rem;background:color-mix(in oklab,#8B4513 8%, var(--paper));border-radius:.5rem;border-left:3px solid #8B4513}
    .reply{padding:.5rem 0;font-size:.9rem;position:relative;line-height:1.5}
    .reply:not(:last-child){border-bottom:1px solid color-mix(in oklab,#8B4513 15%, var(--paper))}
    .reply .who{font-weight:600;margin-right:.5rem;color:#8B4513;opacity:.9}
    .reply .who::before{content:'â†³';margin-right:.3rem;opacity:.6}
    .reply-form{display:grid;gap:.3rem;margin-top:.6rem;padding:.5rem;background:color-mix(in oklab,var(--accent) 5%, var(--paper));border-radius:.5rem}
    .reply-form input{padding:.4rem;border:1px solid var(--line);border-radius:.4rem;font-size:.85rem}
    .reply-btn{padding:.3rem .6rem;font-size:.8rem;cursor:pointer;background:none;border:1px solid var(--line);border-radius:.4rem;color:var(--spine);transition:all .2s;margin-top:.3rem}
    .reply-btn:hover{background:var(--accent);border-color:var(--line-strong)}

    /* ë³„ì  ì…ë ¥ (ë¼ë””ì˜¤) */
    .star-input{display:inline-flex;flex-direction:row-reverse;gap:.05rem}
    .star-input input{display:none}
    .star-input label{cursor:pointer;font-size:1.6rem;color:#ccc;filter:drop-shadow(0 1px 0 rgba(0,0,0,.12));position:relative}
    .star-input label.half-star{width:0.5em;overflow:hidden;margin-right:-0.5em}
    .star-input input:checked ~ label,
    .star-input label:hover,
    .star-input label:hover ~ label{color:gold}
  </style>
</head>
<body class="subpage" data-page="book-detail">
  <a href="#main" class="sr-only">ë³¸ë¬¸ìœ¼ë¡œ ê±´ë„ˆë›°ê¸°</a>
  <header class="site-header is-solid">
    <a class="logo" href="../index.html">êµí™˜ë…ì„œ</a>
    <nav aria-label="ì£¼ìš”">
      <ul class="gnb">
        <li><a href="../index.html?from=internal">í™ˆ</a></li>
        <li><a href="schedule.html">ì¼ì •</a></li>
        <li><a href="library.html">ë„ì„œê´€</a></li>
        <li><a href="community.html">ì»¤ë®¤ë‹ˆí‹°</a></li>
        <li><a href="myspace.html">ë‚´ í”„ë¡œí•„</a></li>
      </ul>
    </nav>
  </header>
  <main id="main">
    <h1>< ì±… ìƒì„¸ ></h1>
    <section class="detail-wrap">
      <div class="cover" id="cover"></div>
      <div class="meta">
        <h2 id="title" style="margin:0"></h2>
        <p id="author" class="muted" style="margin:.2rem 0 0 0"></p>
        <p id="bookInfo" class="muted" style="margin:.2rem 0 0 0"></p>
        <div class="rating" id="rating"></div>
        <div id="tags" style="margin-top:.3rem"></div>
        <p id="desc" style="margin-top:.6rem"></p>
        
        <!-- ë§í¬ ë³µì‚¬ ë²„íŠ¼ -->
        <button id="copyLinkBtn" class="btn ghost" style="margin-top:.6rem;width:fit-content">ğŸ”— ë§í¬ ë³µì‚¬</button>

        <div class="panel">
          <h3 style="margin:.2rem 0">í›„ê¸° ë‚¨ê¸°ê¸°</h3>
          <form id="reviewForm" class="review-form">
            <div class="star-input" aria-label="ë³„ì  ì£¼ê¸°">
              <input type="radio" name="rating" id="r5" value="5"><label for="r5">â˜…</label>
              <input type="radio" name="rating" id="r4_5" value="4.5"><label for="r4_5" class="half-star">â˜…</label>
              <input type="radio" name="rating" id="r4" value="4"><label for="r4">â˜…</label>
              <input type="radio" name="rating" id="r3_5" value="3.5"><label for="r3_5" class="half-star">â˜…</label>
              <input type="radio" name="rating" id="r3" value="3" checked><label for="r3">â˜…</label>
              <input type="radio" name="rating" id="r2_5" value="2.5"><label for="r2_5" class="half-star">â˜…</label>
              <input type="radio" name="rating" id="r2" value="2"><label for="r2">â˜…</label>
              <input type="radio" name="rating" id="r1_5" value="1.5"><label for="r1_5" class="half-star">â˜…</label>
              <input type="radio" name="rating" id="r1" value="1"><label for="r1">â˜…</label>
              <input type="radio" name="rating" id="r0_5" value="0.5"><label for="r0_5" class="half-star">â˜…</label>
            </div>
            <textarea name="comment" placeholder="ì–´ë• ëŠ”ì§€ ì§§ê²Œ ë‚¨ê²¨ ì£¼ì„¸ìš”" required></textarea>
            <div style="display:flex;gap:.5rem;align-items:center">
              <input name="user" placeholder="ì´ë¦„(ì„ íƒ)" style="flex:1;min-width:120px;padding:.5rem;border:1px solid var(--line);border-radius:.5rem">
              <button class="btn" type="submit">í›„ê¸° ë“±ë¡</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <h3 style="margin:0">ë¦¬ë·°</h3>
        <select id="reviewSort" style="padding:.4rem;border:1px solid var(--line);border-radius:.5rem;font-size:.9rem">
          <option value="recent">ìµœì‹ ìˆœ</option>
          <option value="rating">ë³„ì ìˆœ</option>
        </select>
      </div>
      <div id="reviews"></div>
    </section>

  </main>
  
  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="about.html">About</a>
        <span class="footer-divider">Â·</span>
        <a href="https://github.com/sihyeon25/Book-exchange" target="_blank" rel="noopener noreferrer">GitHub</a>
        <span class="footer-divider">Â·</span>
        <a href="mailto:sihyeon25@naver.com">Contact</a>
      </div>
      <small>Â© 2025 êµí™˜ë…ì„œ. All rights reserved.</small>
    </div>
  </footer>

  <script src="../js/bookData.js"></script>
  <script>
    function qs(k){return new URL(location.href).searchParams.get(k)}
    function renderStars(avg){
      const s = [];
      const fullStars = Math.floor(avg);
      const decimal = avg - fullStars;
      const hasHalf = decimal >= 0.25 && decimal < 0.75;
      const roundUp = decimal >= 0.75;
      
      for(let i=1; i<=5; i++){
        if(i <= fullStars || (i === fullStars + 1 && roundUp)) {
          s.push(`<svg class="star" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.787 1.402 8.168L12 18.896 4.664 23.166l1.402-8.168L.132 9.211l8.2-1.193z"/></svg>`);
        } else if(i === fullStars + 1 && hasHalf) {
          s.push(`<svg class="star half" viewBox="0 0 24 24" aria-hidden="true"><defs><linearGradient id="half"><stop offset="50%" stop-color="gold"/><stop offset="50%" stop-color="#ccc"/></linearGradient></defs><path fill="url(#half)" d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.787 1.402 8.168L12 18.896 4.664 23.166l1.402-8.168L.132 9.211l8.2-1.193z"/></svg>`);
        } else {
          s.push(`<svg class="star empty" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.787 1.402 8.168L12 18.896 4.664 23.166l1.402-8.168L.132 9.211l8.2-1.193z"/></svg>`);
        }
      }
      return `<div class="stars" aria-hidden="true">${s.join('')}</div>`
    }

    const id = qs('id');
    const book = getBookById?.(id);
    const coverEl = document.getElementById('cover');
    const titleEl = document.getElementById('title');
    const authorEl = document.getElementById('author');
    const bookInfoEl = document.getElementById('bookInfo');
    const ratingEl = document.getElementById('rating');
    const descEl = document.getElementById('desc');
    const tagsEl = document.getElementById('tags');
    const reviewsEl = document.getElementById('reviews');
    
    let reviewSortOrder = 'recent';

    function render(){
      if(!book){
        titleEl.textContent = 'ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        authorEl.textContent = '';
        coverEl.innerHTML = '<div class="placeholder">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë„ì„œ ëª©ë¡ì—ì„œ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>';
        return;
      }
      
      titleEl.textContent = book.title;
      authorEl.textContent = `${book.author}${book.publisher? ' Â· ' + book.publisher : ''}${book.year? ' Â· ' + book.year : ''}`;
      
      // ë¶„ë¥˜ì™€ í˜ì´ì§€ ìˆ˜ í‘œì‹œ
      const infoArr = [];
      if(book.category) infoArr.push(book.category);
      if(book.pages) infoArr.push(book.pages);
      if(book.selectedBy) {
        const memberHearts = {
          'ì‹œí˜„': 'ğŸ’™',
          'íƒœì´': 'ğŸ©·',
          'í¬ìˆ˜': 'ğŸ’š',
          'ì§€ì›': 'ğŸ’œ'
        };
        const heart = memberHearts[book.selectedBy] || 'ğŸ“š';
        infoArr.push(`${heart} ${book.selectedBy} ì¶”ì²œ`);
      }
      if(infoArr.length > 0) {
        bookInfoEl.textContent = infoArr.join(' Â· ');
        bookInfoEl.style.display = 'block';
      } else {
        bookInfoEl.style.display = 'none';
      }
      
      const avg = computeAverageRating(book);
      ratingEl.innerHTML = `${renderStars(avg)} <strong>${avg || '0.0'}</strong><span class="muted"> / 5</span>`;
      descEl.textContent = book.description || '';
      tagsEl.innerHTML = (book.tags||[]).map(t=>`<span class="pill">#${t}</span>`).join('');

      if(book.cover){
        coverEl.innerHTML = `<img src="${book.cover}" alt="${book.title} í‘œì§€">`;
      }else{
        coverEl.innerHTML = `<div class="placeholder">${book.title}\ní‘œì§€ ì´ë¯¸ì§€ê°€ ì—†ì–´ìš”</div>`;
      }

      // ë¦¬ë·° ë Œë”ë§
      const locals = getLocalReviews(book.id);
      let all = [...(book.reviews||[]), ...(locals||[])];
      
      // ë¡œì»¬ ë¦¬ë·°ì— IDê°€ ì—†ìœ¼ë©´ ìƒì„±
      all = all.map((r, idx) => ({...r, id: r.id || `review_${Date.now()}_${idx}`}));
      
      // ì •ë ¬
      if(reviewSortOrder==='rating'){
        all.sort((a,b) => (b.rating||0) - (a.rating||0));
      }else{
        all.reverse(); // ìµœì‹ ìˆœ (ë‚˜ì¤‘ì— ì¶”ê°€ëœ ê²ƒì´ ìœ„ë¡œ)
      }
      
      if(!all.length){
        reviewsEl.innerHTML = '<p class="muted">ì•„ì§ í›„ê¸°ê°€ ì—†ì–´ìš”. ì²«ë²ˆì§¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
      }else{
        reviewsEl.innerHTML = all.map(r => {
          // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë‹µê¸€ + ê¸°ë³¸ ë¦¬ë·°ì˜ replies í•©ì¹˜ê¸°
          const localReplies = getReviewReplies(book.id, r.id);
          const defaultReplies = r.replies || [];
          const allReplies = [...defaultReplies, ...localReplies];
          
          const repliesHtml = allReplies.length ? 
            `<div class="replies">
              ${allReplies.map((rep, repIdx) => `
                <div class="reply">
                  <span class="who">${rep.user||'ìµëª…'}</span>${rep.comment}
                </div>
              `).join('')}
            </div>` : '';
          
          // ë³„ì  í‘œì‹œ (ë°˜ê°œ ì§€ì›)
          const fullStars = Math.floor(r.rating);
          const decimal = r.rating - fullStars;
          const hasHalf = decimal >= 0.25 && decimal < 0.75;
          const roundUp = decimal >= 0.75;
          
          let starDisplay = 'â˜…'.repeat(fullStars + (roundUp ? 1 : 0));
          if(hasHalf) starDisplay += 'â¯¨';
          starDisplay += 'â˜†'.repeat(5 - fullStars - (hasHalf ? 1 : 0) - (roundUp ? 1 : 0));
          
          return `
            <div class="review" data-review-id="${r.id}">
              <span class="who">${r.user||'ìµëª…'}</span> 
              <span class="muted">${starDisplay}</span>
              <div>${r.comment||''}</div>
              ${repliesHtml}
              <button class="reply-btn" data-review-id="${r.id}">ë‹µê¸€</button>
              <div class="reply-form" id="replyForm_${r.id}" style="display:none">
                <input type="text" placeholder="ì´ë¦„(ì„ íƒ)" class="reply-user">
                <input type="text" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" class="reply-comment">
                <div style="display:flex;gap:.3rem">
                  <button type="button" class="btn" style="flex:1;font-size:.85rem;padding:.3rem" onclick="window.submitReply('${r.id}')">ë“±ë¡</button>
                  <button type="button" class="btn ghost" style="flex:1;font-size:.85rem;padding:.3rem" onclick="window.cancelReply('${r.id}')">ì·¨ì†Œ</button>
                </div>
              </div>
            </div>`;
        }).join('');
        
        // ë‹µê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.reply-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const reviewId = btn.dataset.reviewId;
            const form = document.getElementById(`replyForm_${reviewId}`);
            form.style.display = form.style.display === 'none' ? 'grid' : 'none';
          });
        });
      }
    }
    
    // ë‹µê¸€ ë“±ë¡
    window.submitReply = function(reviewId) {
      const form = document.getElementById(`replyForm_${reviewId}`);
      const user = form.querySelector('.reply-user').value.trim();
      const comment = form.querySelector('.reply-comment').value.trim();
      
      if(!comment) {
        alert('ë‹µê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      addReviewReply(book.id, reviewId, { user: user || 'ìµëª…', comment });
      form.querySelector('.reply-user').value = '';
      form.querySelector('.reply-comment').value = '';
      form.style.display = 'none';
      render();
    }
    
    // ë‹µê¸€ ì·¨ì†Œ
    window.cancelReply = function(reviewId) {
      const form = document.getElementById(`replyForm_${reviewId}`);
      form.querySelector('.reply-user').value = '';
      form.querySelector('.reply-comment').value = '';
      form.style.display = 'none';
    }

    render();
    
    // ì¶”ì²œì¸ ìƒ‰ìƒì— ë”°ë¼ í—¤ë” ìŠ¤íƒ€ì¼ ë³€ê²½
    if(book && book.selectedBy) {
      const memberColors = {
        'ì‹œí˜„': '#5B7A9E',
        'íƒœì´': '#D989A8',
        'í¬ìˆ˜': '#6D9872',
        'ì§€ì›': '#9B86BD'
      };
      const color = memberColors[book.selectedBy];
      if(color) {
        const header = document.querySelector('.site-header');
        header.style.background = 'var(--paper)';
        header.style.borderBottom = `2px solid ${color}`;
        
        // ë¡œê³ ì™€ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ ìƒ‰ìƒ ë³€ê²½
        const logo = header.querySelector('.logo');
        const navLinks = header.querySelectorAll('.gnb a');
        
        if(logo) {
          logo.style.color = color;
          logo.style.fontWeight = '800';
          logo.style.textShadow = 'none';
        }
        navLinks.forEach(link => {
          link.style.color = color;
          link.style.textShadow = 'none';
          link.style.fontWeight = '700';
        });
      }
    }
    
    // ë¦¬ë·° ì •ë ¬
    document.getElementById('reviewSort')?.addEventListener('change', e => {
      reviewSortOrder = e.target.value;
      render();
    });
    
    // ë§í¬ ë³µì‚¬
    document.getElementById('copyLinkBtn')?.addEventListener('click', () => {
      const url = location.href;
      navigator.clipboard.writeText(url).then(() => {
        alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }).catch(() => {
        alert('ë³µì‚¬ ì‹¤íŒ¨. ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      });
    });

    // í›„ê¸° ì‘ì„± ì²˜ë¦¬
    const form = document.getElementById('reviewForm');
    form?.addEventListener('submit', (e) => {
      e.preventDefault();
      if(!book) return;
      const fd = new FormData(form);
      const rating = Number(fd.get('rating')) || 3;
      const comment = String(fd.get('comment')||'').trim();
      const user = String(fd.get('user')||'').trim();
      if(!comment){
        alert('í›„ê¸°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      addLocalReview(book.id, { user: user||'ìµëª…', rating, comment });
      form.reset();
      render();
    });
  </script>
  <script src="../js/page-transitions.js"></script>
</body>
</html>
