<!--
  ====================================
  BOOK DETAIL PAGE
  ì±… ìƒì„¸ ì •ë³´ í˜ì´ì§€
  ====================================
  
  í˜ì´ì§€ ê¸°ëŠ¥:
  1. ì±… ìƒì„¸ ì •ë³´ (í‘œì§€, ì œëª©, ì €ì ë“±)
  2. ë³„ì  í‘œì‹œ
  3. ë¦¬ë·° ì‘ì„± ë° ë³´ê¸°
  4. ë¦¬ë·°ì— ë‹µê¸€
  5. ë¦¬ë·° ì •ë ¬ (ìµœì‹ ìˆœ/ë³„ì ìˆœ)
  6. ë‚´ ë¦¬ë·° ë³µì‚¬ ê¸°ëŠ¥
  
  íŠ¹ì§•:
  - ì¶”ì²œì¸ë³„ ìƒ‰ìƒ í…Œë§ˆ
  - ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¦¬ë·° ì €ì¥
  - ë‹µê¸€ ì‹œìŠ¤í…œ
-->
<!DOCTYPE html>
<html lang="ko" data-theme="heritage">
<head>
  <!-- ====================================
       META & COMPATIBILITY SETUP
       ê¸°ë³¸ ë©”íƒ€ ì •ë³´ ë° í˜¸í™˜ì„± ì„¤ì •
  ===================================== -->
  <meta charset="utf-8">
  <!-- ëª¨ë°”ì¼ í™”ë©´ ìµœì í™”: ì¤„ì´ê¸° ë°©ì§€, ì´ˆê¸° ìŠ¤ì¼€ì¼ 1.0 -->
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=5.0,user-scalable=yes">
  <!-- iOS Safari íŒë• ë°” ìŠ¤íƒ€ì¼ë§ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <!-- Android Chrome í…Œë§ˆ ìƒ‰ìƒ -->
  <meta name="theme-color" content="#2C2C2C">
  <meta name="msapplication-navbutton-color" content="#2C2C2C">
  <!-- Windows Phone íƒ€ì´í‹€ ë°” ìƒ‰ìƒ -->
  <meta name="msapplication-TileColor" content="#2C2C2C">
  <!-- ê²€ìƒ‰ ì—”ì§„ ì˜µí‹°ë§ˆì´ì œì´ì…˜ -->
  <meta name="description" content="êµí™˜ë…ì„œ í”„ë¡œì íŠ¸ - ì±… ìƒì„¸ ì •ë³´ì™€ ë¦¬ë·°">
  <meta name="keywords" content="ë…ì„œ, êµí™˜, ë¦¬ë·°, ì±…">
  <!-- SNS ê³µìœ  ë©”íƒ€ íƒœê·¸ -->
  <meta property="og:title" content="êµí™˜ë…ì„œ - ì±… ìƒì„¸">
  <meta property="og:description" content="ì±… ìƒì„¸ ì •ë³´ì™€ ë¦¬ë·°ë¥¼ í™•ì¸í•˜ì„¸ìš”">
  <meta property="og:type" content="website">
  <!-- í°ë¹„ì½˜ -->
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <title>êµí™˜ë…ì„œ â€“ ì±… ìƒì„¸</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* ==============================================
       ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ - ëª¨ë“  í™”ë©´ í¬ê¸°ì—ì„œ ì‘ë™
    ============================================== */
    .detail-wrap{
      display:grid;
      gap:1.25rem;
      grid-template-columns: 1fr;
      padding:1rem;
    }
    
    /* íƒœë¸”ë¦¿ ë° ë°ìŠ¤í¬í†± (768px ì´ìƒ) */
    @media(min-width:768px){
      .detail-wrap{
        padding:1.5rem;
        gap:1.5rem;
      }
    }
    
    /* ëŒ€í˜• í™”ë©´ (900px ì´ìƒ) */
    @media(min-width:900px){
      .detail-wrap{
        grid-template-columns: 320px 1fr;
        padding:2rem;
      }
    }
    
    /* ê·¹ì†Œí˜• í™”ë©´ (320px ë¯¸ë§Œ) ëŒ€ì‘ */
    @media(max-width:319px){
      .detail-wrap{
        padding:0.5rem;
        gap:1rem;
      }
    }
    
    /* ì±… í‘œì§€ - ëª¨ë“  ê¸°ê¸°ì—ì„œ ì˜ ë³´ì´ë„ë¡ */
    .cover{
      aspect-ratio:2/3;
      border:1px solid var(--line);
      border-radius:.8rem;
      background:linear-gradient(135deg, color-mix(in oklab,var(--accent) 30%, var(--paper)), var(--paper));
      display:grid;
      place-items:center;
      box-shadow:0 2px 0 rgba(0,0,0,.04),0 12px 28px rgba(0,0,0,.08);
      max-width:100%;
      height:auto;
    }
    
    .cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:.8rem;
      /* ì´ë¯¸ì§€ ë¡œë”© ì—ëŸ¬ ë°©ì§€ */
      background-color:#f5f5f5;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°œì„  */
    .cover .placeholder{
      font-family:'Nanum Myeongjo',serif,-apple-system,BlinkMacSystemFont,sans-serif;
      color:#555;
      font-size:1rem;
      text-align:center;
      padding:1rem;
      line-height:1.5;
    }
    
    @media(min-width:768px){
      .cover .placeholder{
        font-size:1.1rem;
      }
    }
    /* ==============================================
       ì¸í„°ë™ì…˜ ìš”ì†Œ - ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™”
    ============================================== */
    .meta{display:grid;gap:.4rem;}
    .rating{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
    
    .stars{
      --size:20px;
      display:inline-flex;
      gap:2px;
      /* í„°ì¹˜ ê¸°ê¸°ì—ì„œ ì‰¬ê²Œ ëˆ„ë¥¼ ìˆ˜ ìˆë„ë¡ */
      min-height:24px;
    }
    
    /* íƒœë¸”ë¦¿ì—ì„œ ë³„ì  í¬ê¸° ì¦ê°€ */
    @media(min-width:768px){
      .stars{--size:22px;}
    }
    
    .star{
      width:var(--size);
      height:var(--size);
      fill:gold;
      filter:drop-shadow(0 1px 0 rgba(0,0,0,.12));
    }
    
    .star.empty{fill:#ccc;}
    
    /* íƒœê·¸ - ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      margin:.2rem .35rem .2rem 0;
      padding:.3rem .7rem;
      background:color-mix(in oklab,var(--accent) 15%, var(--paper));
      border-radius:.6rem;
      font-size:.85rem;
      color:#333;
      font-weight:500;
      line-height:1.2;
      /* ëª¨ë°”ì¼ í„°ì¹˜ ë°˜ì‘ */
      touch-action:manipulation;
    }
    
    @media(min-width:768px){
      .pill{
        font-size:.9rem;
        margin-right:.35rem;
        margin-top:0;
        margin-bottom:0;
      }
    }
    /* ==============================================
       í¼ê³¼ ë¦¬ë·° - ëª¨ë°”ì¼ ì¹œí™”ì  ë””ìì¸
    ============================================== */
    .review-form{
      display:grid;
      gap:.7rem;
      margin-top:1rem;
    }
    
    .review-form textarea{
      min-height:100px;
      resize:vertical;
      padding:.8rem;
      border-radius:.6rem;
      border:1px solid var(--line);
      font-family:inherit;
      font-size:1rem;
      line-height:1.5;
      /* iOS Safari ì¤„ì´ê¸° ë°©ì§€ */
      -webkit-appearance:none;
      appearance:none;
      /* ëª¨ë°”ì¼ í‚¤ë³´ë“œ ìµœì í™” */
      touch-action:manipulation;
    }
    
    @media(max-width:767px){
      .review-form textarea{
        min-height:80px;
        padding:.6rem;
      }
    }
    
    .review{
      border-top:1px solid var(--line);
      padding:.75rem 0;
      /* ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ê°œì„  */
      scroll-margin-top:2rem;
    }
    
    .review .who{
      font-weight:700;
      margin-right:.4rem;
      /* ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ */
      word-break:keep-all;
    }
    
    /* ë‹µê¸€ ì‹œìŠ¤í…œ - ëª¨ë°”ì¼ ìµœì í™” */
    
    .replies{
      margin:1rem 0 .6rem 1rem;
      padding:.6rem .8rem;
      background:var(--paper);
      border-radius:.5rem;
      border-left:3px solid var(--line);
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ ë‹µê¸€ ì—¬ë°± ì¡°ì • */
    @media(max-width:767px){
      .replies{
        margin-left:.5rem;
        padding:.5rem .6rem;
      }
    }
    
    .reply{
      padding:.5rem 0;
      font-size:.9rem;
      position:relative;
      line-height:1.5;
      word-wrap:break-word;
    }
    
    .reply:not(:last-child){
      border-bottom:1px solid var(--line);
    }
    
    .reply .who{
      font-weight:600;
      margin-right:.5rem;
      color:var(--spine);
    }
    
    .reply .who::before{
      content:'â†³';
      margin-right:.3rem;
      opacity:.6;
    }
    
    .reply-form{
      display:grid;
      gap:.4rem;
      margin-top:.6rem;
      padding:.6rem;
      background:color-mix(in oklab,var(--accent) 5%, var(--paper));
      border-radius:.5rem;
    }
    
    .reply-form input{
      padding:.5rem;
      border:1px solid var(--line);
      border-radius:.4rem;
      font-size:.9rem;
      /* iOS ì¤„ì´ê¸° ë°©ì§€ */
      -webkit-appearance:none;
      appearance:none;
    }
    
    @media(max-width:767px){
      .reply-form input{
        padding:.4rem;
        font-size:.85rem;
      }
    }
    
    .reply-btn{
      padding:.4rem .8rem;
      font-size:.8rem;
      cursor:pointer;
      background:none;
      border:1px solid var(--line);
      border-radius:.4rem;
      color:var(--spine);
      transition:all .2s;
      margin-top:.3rem;
      /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
      touch-action:manipulation;
      min-height:44px;
    }
    
    .reply-btn:hover,.reply-btn:focus{
      background:var(--accent);
      border-color:var(--line-strong);
    }
    
    /* ë³„ì  ì…ë ¥ - ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
    .star-input{
      display:inline-flex;
      flex-direction:row-reverse;
      gap:.1rem;
      flex-wrap:wrap;
      justify-content:center;
    }
    
    @media(min-width:768px){
      .star-input{
        gap:.05rem;
        justify-content:flex-start;
      }
    }
    
    .star-input input{display:none;}
    
    .star-input label{
      cursor:pointer;
      font-size:1.8rem;
      color:#ccc;
      filter:drop-shadow(0 1px 0 rgba(0,0,0,.12));
      position:relative;
      /* ëª¨ë°”ì¼ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
      padding:.2rem;
      touch-action:manipulation;
      min-width:40px;
      min-height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    @media(min-width:768px){
      .star-input label{
        font-size:1.6rem;
        padding:.1rem;
        min-width:auto;
        min-height:auto;
      }
    }
    
    .star-input input:checked ~ label,
    .star-input label:hover,
    .star-input label:hover ~ label{
      color:gold;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ hover íš¨ê³¼ ë¹„í™œì„±í™” */
    @media (hover: none) {
      .star-input label:hover,
      .star-input label:hover ~ label {
        color:#ccc;
      }
      
      .star-input input:checked ~ label {
        color:gold;
      }
    }
  </style>
</head>
<body class="subpage" data-page="book-detail">
  <a href="#main" class="sr-only">ë³¸ë¬¸ìœ¼ë¡œ ê±´ë„ˆë›°ê¸°</a>
  <header class="site-header is-solid">
    <a class="logo" href="../index.html">êµí™˜ë…ì„œ</a>
    <nav aria-label="ì£¼ìš”">
      <ul class="gnb">
        <li><a href="../index.html?from=internal">í™ˆ</a></li>
        <li><a href="schedule.html">ì¼ì •</a></li>
        <li><a href="library.html">ë„ì„œê´€</a></li>
        <li><a href="community.html">ê²Œì‹œíŒ</a></li>
      </ul>
    </nav>
  </header>
  <main id="main">
    <h1>< ì±… ìƒì„¸ ></h1>
    <section class="detail-wrap">
      <div class="cover" id="cover"></div>
      <div class="meta">
        <h2 id="title" style="margin:0"></h2>
        <p id="author" style="margin:.2rem 0 0 0;color:#333"></p>
        <p id="bookInfo" style="margin:.2rem 0 0 0;color:#333"></p>
        <div class="rating" id="rating"></div>
        <div id="tags" style="margin-top:.3rem"></div>
        <p id="desc" style="margin-top:.6rem"></p>
        
        <!-- ë§í¬ ë³µì‚¬ ë²„íŠ¼ -->
        <button id="copyReviewBtn" class="btn ghost" style="margin-top:.6rem;width:fit-content">ğŸ“ ë‚´ ë¦¬ë·° ë³µì‚¬</button>

        <div class="panel">
          <h3 style="margin:.2rem 0">í›„ê¸° ë‚¨ê¸°ê¸°</h3>
          <form id="reviewForm" class="review-form">
            <div class="star-input" aria-label="ë³„ì  ì£¼ê¸°">
              <input type="radio" name="rating" id="r5" value="5"><label for="r5">â˜…</label>
              <input type="radio" name="rating" id="r4" value="4"><label for="r4">â˜…</label>
              <input type="radio" name="rating" id="r3" value="3" checked><label for="r3">â˜…</label>
              <input type="radio" name="rating" id="r2" value="2"><label for="r2">â˜…</label>
              <input type="radio" name="rating" id="r1" value="1"><label for="r1">â˜…</label>
            </div>
            <textarea name="comment" placeholder="ì–´ë• ëŠ”ì§€ ì§§ê²Œ ë‚¨ê²¨ ì£¼ì„¸ìš”" required></textarea>
            <div style="display:flex;gap:.5rem;align-items:center">
              <input name="user" placeholder="ì´ë¦„(ì„ íƒ)" style="flex:1;min-width:120px;padding:.5rem;border:1px solid var(--line);border-radius:.5rem">
              <button class="btn" type="submit">í›„ê¸° ë“±ë¡</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <h3 style="margin:0">ë¦¬ë·°</h3>
        <select id="reviewSort" style="padding:.4rem;border:1px solid var(--line);border-radius:.5rem;font-size:.9rem">
          <option value="recent">ìµœì‹ ìˆœ</option>
          <option value="rating">ë³„ì ìˆœ</option>
        </select>
      </div>
      <div id="reviews"></div>
    </section>

  </main>
  
  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="about.html">About</a>
        <span class="footer-divider">Â·</span>
        <a href="https://github.com/sihyeon25/Book-exchange" target="_blank" rel="noopener noreferrer">GitHub</a>
        <span class="footer-divider">Â·</span>
        <a href="mailto:sihyeon25@naver.com">Contact</a>
      </div>
      <small>Â© 2025 êµí™˜ë…ì„œ. All rights reserved.</small>
    </div>
  </footer>

  <script src="../js/bookData.js"></script>
  <script>
    // ==============================================
    // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ë° ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”
    // ==============================================
    
    // URLì—ì„œ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸° (êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ì‘)
    function qs(k){
      try {
        // URLSearchParams ì§€ì› ì—¬ë¶€ í™•ì¸
        if (typeof URLSearchParams !== 'undefined') {
          return new URLSearchParams(location.search).get(k);
        } else {
          // êµ¬í˜• ë¸Œë¼ìš°ì €ë¥¼ ìœ„í•œ í´ë°±
          const params = location.search.substring(1).split('&');
          for (let i = 0; i < params.length; i++) {
            const pair = params[i].split('=');
            if (decodeURIComponent(pair[0]) === k) {
              return decodeURIComponent(pair[1] || '');
            }
          }
          return null;
        }
      } catch (e) {
        console.warn('íŒŒë¼ë¯¸í„° íŒŒì‹± ì˜¤ë¥˜:', e);
        return null;
      }
    }
    
    // í‰ì ì— ë”°ë¼ ë³„ ê·¸ë¦¬ê¸° (ì •ìˆ˜ ë°˜ì˜¬ë¦¼)
    function renderStars(avg){
      if (typeof avg !== 'number' || isNaN(avg)) avg = 0;
      
      var s = [];
      var stars = Math.round(avg);
      
      for(var i=1; i<=5; i++){
        if(i <= stars) {
          s.push('<svg class="star" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.787 1.402 8.168L12 18.896 4.664 23.166l1.402-8.168L.132 9.211l8.2-1.193z"/></svg>');
        } else {
          s.push('<svg class="star empty" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.787 1.402 8.168L12 18.896 4.664 23.166l1.402-8.168L.132 9.211l8.2-1.193z"/></svg>');
        }
      }
      return '<div class="stars" aria-hidden="true">' + s.join('') + '</div>';
    }

    // í˜„ì¬ í˜ì´ì§€ì˜ ì±… ID ê°€ì ¸ì˜¤ê¸°
    var id = qs('id');
    var book = null;
    
    // bookData.js ë¡œë“œ ì—¬ë¶€ ë° ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
    try {
      if (typeof getBookById === 'function') {
        book = getBookById(id);
      } else {
        console.error('getBookById í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    } catch (e) {
      console.error('ì±… ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
    }
    
    // DOM ì—˜ë¦¬ë¨¼íŠ¸ë“¤ ì•ˆì „í•˜ê²Œ ì°¸ì¡° ì €ì¥ (ë„ ì²´í¬ í¬í•¨)
    var coverEl = document.getElementById('cover');
    var titleEl = document.getElementById('title');
    var authorEl = document.getElementById('author');
    var bookInfoEl = document.getElementById('bookInfo');
    var ratingEl = document.getElementById('rating');
    var descEl = document.getElementById('desc');
    var tagsEl = document.getElementById('tags');
    var reviewsEl = document.getElementById('reviews');
    
    var reviewSortOrder = 'recent'; // ë¦¬ë·° ì •ë ¬ ìˆœì„œ

    // ì±… ì •ë³´ì™€ ë¦¬ë·°ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function render(){
      if(!book){
        titleEl.textContent = 'ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        authorEl.textContent = '';
        coverEl.innerHTML = '<div class="placeholder">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë„ì„œ ëª©ë¡ì—ì„œ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>';
        return;
      }
      
      titleEl.textContent = book.title;
      authorEl.textContent = `${book.author}${book.publisher? ' Â· ' + book.publisher : ''}${book.year? ' Â· ' + book.year : ''}`;
      
      // ë¶„ë¥˜ì™€ í˜ì´ì§€ ìˆ˜ í‘œì‹œ
      const infoArr = [];
      if(book.category) infoArr.push(book.category);
      if(book.pages) infoArr.push(book.pages);
      if(book.selectedBy) {
        const memberHearts = {
          'ì‹œí˜„': 'ğŸ’™',
          'íƒœì´': 'ğŸ©·',
          'í¬ìˆ˜': 'ğŸ’š',
          'ì§€ì›': 'ğŸ’œ'
        };
        const heart = memberHearts[book.selectedBy] || 'ğŸ“š';
        infoArr.push(`${heart} ${book.selectedBy} ì¶”ì²œ`);
      }
      if(infoArr.length > 0) {
        bookInfoEl.textContent = infoArr.join(' Â· ');
        bookInfoEl.style.display = 'block';
      } else {
        bookInfoEl.style.display = 'none';
      }
        
        // í‰ì  í‘œì‹œ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
        if (ratingEl && typeof computeAverageRating === 'function') {
          try {
            var avg = computeAverageRating(book);
            ratingEl.innerHTML = renderStars(avg) + ' <strong>' + (avg || '0.0') + '</strong><span class="muted"> / 5</span>';
          } catch (e) {
            console.warn('í‰ì  ê³„ì‚° ì˜¤ë¥˜:', e);
            ratingEl.innerHTML = '<span class="muted">í‰ì  ì—†ìŒ</span>';
          }
        }
        
        // ì„¤ëª…ê³¼ íƒœê·¸ í‘œì‹œ
        if (descEl) descEl.textContent = book.description || '';
        if (tagsEl && book.tags) {
          var tagsHtml = '';
          for (var i = 0; i < book.tags.length; i++) {
            tagsHtml += '<span class="pill">#' + book.tags[i] + '</span>';
          }
          tagsEl.innerHTML = tagsHtml;
        }

        // í‘œì§€ ì´ë¯¸ì§€ ì²˜ë¦¬ (ì˜¤ë¥˜ ëŒ€ë¹„)
        if(book.cover){
          var img = new Image();
          img.onload = function() {
            coverEl.innerHTML = '<img src="' + book.cover + '" alt="' + book.title + ' í‘œì§€">';
          };
          img.onerror = function() {
            coverEl.innerHTML = '<div class="placeholder">' + book.title + '\ní‘œì§€ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ì–´ìš”</div>';
          };
          img.src = book.cover;
        } else {
          coverEl.innerHTML = '<div class="placeholder">' + book.title + '\ní‘œì§€ ì´ë¯¸ì§€ê°€ ì—†ì–´ìš”</div>';
        }

      // ë¦¬ë·° ë Œë”ë§
      const locals = getLocalReviews(book.id);
      let all = [...(book.reviews||[]), ...(locals||[])];
      
      // ë¡œì»¬ ë¦¬ë·°ì— IDê°€ ì—†ìœ¼ë©´ ìƒì„±
      all = all.map((r, idx) => ({...r, id: r.id || `review_${Date.now()}_${idx}`}));
      
      // ì •ë ¬
      if(reviewSortOrder==='rating'){
        all.sort((a,b) => (b.rating||0) - (a.rating||0));
      }else{
        all.reverse(); // ìµœì‹ ìˆœ (ë‚˜ì¤‘ì— ì¶”ê°€ëœ ê²ƒì´ ìœ„ë¡œ)
      }
      
      if(!all.length){
        reviewsEl.innerHTML = '<p class="muted">ì•„ì§ í›„ê¸°ê°€ ì—†ì–´ìš”. ì²«ë²ˆì§¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
      }else{
        reviewsEl.innerHTML = all.map(r => {
          // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë‹µê¸€ + ê¸°ë³¸ ë¦¬ë·°ì˜ replies í•©ì¹˜ê¸°
          const localReplies = getReviewReplies(book.id, r.id);
          const defaultReplies = r.replies || [];
          const allReplies = [...defaultReplies, ...localReplies];
          
          const repliesHtml = allReplies.length ? 
            `<div class="replies">
              ${allReplies.map((rep, repIdx) => `
                <div class="reply">
                  <span class="who">${rep.user||'ìµëª…'}</span>${rep.comment}
                </div>
              `).join('')}
            </div>` : '';
          
          // ë³„ì  í‘œì‹œ (ì •ìˆ˜ë§Œ)
          const stars = Math.round(r.rating);
          let starDisplay = 'â˜…'.repeat(stars) + 'â˜†'.repeat(5 - stars);
          
          return `
            <div class="review" data-review-id="${r.id}">
              <span class="who">${r.user||'ìµëª…'}</span> 
              <span class="muted">${starDisplay}</span>
              <div>${r.comment||''}</div>
              ${repliesHtml}
              <button class="reply-btn" data-review-id="${r.id}">ë‹µê¸€</button>
              <div class="reply-form" id="replyForm_${r.id}" style="display:none">
                <input type="text" placeholder="ì´ë¦„(ì„ íƒ)" class="reply-user">
                <input type="text" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" class="reply-comment">
                <div style="display:flex;gap:.3rem">
                  <button type="button" class="btn" style="flex:1;font-size:.85rem;padding:.3rem" onclick="window.submitReply('${r.id}')">ë“±ë¡</button>
                  <button type="button" class="btn ghost" style="flex:1;font-size:.85rem;padding:.3rem" onclick="window.cancelReply('${r.id}')">ì·¨ì†Œ</button>
                </div>
              </div>
            </div>`;
        }).join('');
        
        // ë‹µê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.reply-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const reviewId = btn.dataset.reviewId;
            const form = document.getElementById(`replyForm_${reviewId}`);
            form.style.display = form.style.display === 'none' ? 'grid' : 'none';
          });
        });
      }
    }
    
    // ë‹µê¸€ ë“±ë¡
    window.submitReply = function(reviewId) {
      const form = document.getElementById(`replyForm_${reviewId}`);
      const user = form.querySelector('.reply-user').value.trim();
      const comment = form.querySelector('.reply-comment').value.trim();
      
      if(!comment) {
        alert('ë‹µê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      addReviewReply(book.id, reviewId, { user: user || 'ìµëª…', comment });
      form.querySelector('.reply-user').value = '';
      form.querySelector('.reply-comment').value = '';
      form.style.display = 'none';
      render();
    }
    
    // ë‹µê¸€ ì·¨ì†Œ
    window.cancelReply = function(reviewId) {
      const form = document.getElementById(`replyForm_${reviewId}`);
      form.querySelector('.reply-user').value = '';
      form.querySelector('.reply-comment').value = '';
      form.style.display = 'none';
    }

    render();
    
    // ë¦¬ë·° ì •ë ¬
    document.getElementById('reviewSort')?.addEventListener('change', e => {
      reviewSortOrder = e.target.value;
      render();
    });
    
    // ë‚´ ë¦¬ë·° ë³µì‚¬
    document.getElementById('copyReviewBtn')?.addEventListener('click', () => {
      const form = document.getElementById('reviewForm');
      if(!form) return;
      
      const ratingInput = form.querySelector('input[name="rating"]:checked');
      const commentInput = form.querySelector('textarea[name="comment"]');
      const userInput = form.querySelector('input[name="user"]');
      
      const rating = ratingInput ? ratingInput.value : '';
      const comment = commentInput ? commentInput.value.trim() : '';
      const user = userInput ? userInput.value.trim() : '';
      
      if(!comment) {
        alert('ë¦¬ë·°ë¥¼ ë¨¼ì € ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const reviewData = {
        book: book ? book.title : '',
        user: user || 'ìµëª…',
        rating: rating,
        comment: comment
      };
      
      const reviewText = `ì±…: ${reviewData.book}\nì´ë¦„: ${reviewData.user}\në³„ì : ${reviewData.rating}\në¦¬ë·°: ${reviewData.comment}`;
      
      navigator.clipboard.writeText(reviewText).then(() => {
        alert('ë¦¬ë·°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nê°œë°œìì—ê²Œ ì „ë‹¬í•´ì£¼ì„¸ìš”.');
      }).catch(() => {
        // í´ë¦½ë³´ë“œ ì‹¤íŒ¨ ì‹œ alertë¡œ í…ìŠ¤íŠ¸ í‘œì‹œ
        alert(`ë³µì‚¬ ì‹¤íŒ¨. ì•„ë˜ ë‚´ìš©ì„ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”:\n\n${reviewText}`);
      });
    });

    // í›„ê¸° ì‘ì„± ì²˜ë¦¬
    const form = document.getElementById('reviewForm');
    form?.addEventListener('submit', (e) => {
      e.preventDefault();
      if(!book) return;
      const fd = new FormData(form);
      const rating = Number(fd.get('rating')) || 3;
      const comment = String(fd.get('comment')||'').trim();
      const user = String(fd.get('user')||'').trim();
      if(!comment){
        alert('í›„ê¸°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      addLocalReview(book.id, { user: user||'ìµëª…', rating, comment });
      form.reset();
      render();
    });
  </script>
  <script src="../js/page-transitions.js"></script>
</body>
</html>
