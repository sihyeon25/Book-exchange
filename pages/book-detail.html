<!DOCTYPE html>
<html lang="ko" data-theme="heritage">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>êµí™˜ë…ì„œ â€“ ì±… ìƒì„¸</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .detail-wrap{display:grid;gap:1.25rem;grid-template-columns: 1fr;}
    @media(min-width:900px){.detail-wrap{grid-template-columns: 320px 1fr}}
    .cover{aspect-ratio:2/3;border:1px solid var(--line);border-radius:.8rem;background:linear-gradient(135deg, color-mix(in oklab,var(--accent) 30%, var(--paper)), var(--paper));display:grid;place-items:center;box-shadow:0 2px 0 rgba(0,0,0,.04),0 12px 28px rgba(0,0,0,.08)}
    .cover img{width:100%;height:100%;object-fit:cover;border-radius:.8rem}
    .cover .placeholder{font-family:'Nanum Myeongjo',serif;color:#000a;font-size:1.1rem;text-align:center;padding:1rem}
    .meta{display:grid;gap:.4rem}
    .rating{display:flex;align-items:center;gap:.5rem}
    .stars{--size:22px;display:inline-flex;gap:2px}
    .star{width:var(--size);height:var(--size);color:gold;filter:drop-shadow(0 1px 0 rgba(0,0,0,.12))}
    .star.empty{color:#ccc}
    .pill{display:inline-flex;align-items:center;gap:.25rem;margin-right:.35rem}
    .review-form{display:grid;gap:.5rem;margin-top:1rem}
    .review-form textarea{min-height:88px;resize:vertical;padding:.6rem;border-radius:.6rem;border:1px solid var(--line)}
    .review{border-top:1px solid var(--line);padding:.75rem 0}
    .review .who{font-weight:700;margin-right:.4rem}

    /* ë³„ì  ì…ë ¥ (ë¼ë””ì˜¤) */
    .star-input{display:inline-flex;flex-direction:row-reverse;gap:.25rem}
    .star-input input{display:none}
    .star-input label{cursor:pointer;font-size:1.6rem;color:#ccc;filter:drop-shadow(0 1px 0 rgba(0,0,0,.12))}
    .star-input input:checked ~ label,
    .star-input label:hover,
    .star-input label:hover ~ label{color:gold}
  </style>
</head>
<body>
  <a href="#main" class="sr-only">ë³¸ë¬¸ìœ¼ë¡œ ê±´ë„ˆë›°ê¸°</a>
  <header class="site-header">
    <a class="logo" href="../index.html">êµí™˜ë…ì„œ</a>
    <nav aria-label="ì£¼ìš”">
      <ul class="gnb">
        <li><a href="../index.html">í™ˆ</a></li>
        <li><a href="schedule.html">ì¼ì •</a></li>
        <li><a href="library.html">ë„ì„œê´€</a></li>
        <li><a href="community.html">ì»¤ë®¤ë‹ˆí‹°</a></li>
      </ul>
    </nav>
  </header>
  <main id="main">
    <h1>ì±… ìƒì„¸</h1>
    <section class="detail-wrap">
      <div class="cover" id="cover"></div>
      <div class="meta">
        <h2 id="title" style="margin:0"></h2>
        <p id="author" class="muted" style="margin:.2rem 0 0 0"></p>
        <div class="rating" id="rating"></div>
        <div id="tags" style="margin-top:.3rem"></div>
        <p id="desc" style="margin-top:.6rem"></p>
        
        <!-- ë§í¬ ë³µì‚¬ ë²„íŠ¼ -->
        <button id="copyLinkBtn" class="btn ghost" style="margin-top:.6rem;width:fit-content">ğŸ”— ë§í¬ ë³µì‚¬</button>

        <div class="panel">
          <h3 style="margin:.2rem 0">í›„ê¸° ë‚¨ê¸°ê¸°</h3>
          <form id="reviewForm" class="review-form">
            <div class="star-input" aria-label="ë³„ì  ì£¼ê¸°">
              <input type="radio" name="rating" id="r5" value="5"><label for="r5">â˜…</label>
              <input type="radio" name="rating" id="r4" value="4"><label for="r4">â˜…</label>
              <input type="radio" name="rating" id="r3" value="3" checked><label for="r3">â˜…</label>
              <input type="radio" name="rating" id="r2" value="2"><label for="r2">â˜…</label>
              <input type="radio" name="rating" id="r1" value="1"><label for="r1">â˜…</label>
            </div>
            <textarea name="comment" placeholder="ì–´ë• ëŠ”ì§€ ì§§ê²Œ ë‚¨ê²¨ ì£¼ì„¸ìš”" required></textarea>
            <div style="display:flex;gap:.5rem;align-items:center">
              <input name="user" placeholder="ì´ë¦„(ì„ íƒ)" style="flex:1;min-width:120px;padding:.5rem;border:1px solid var(--line);border-radius:.5rem">
              <button class="btn" type="submit">í›„ê¸° ë“±ë¡</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
        <h3 style="margin:0">ë¦¬ë·°</h3>
        <select id="reviewSort" style="padding:.4rem;border:1px solid var(--line);border-radius:.5rem;font-size:.9rem">
          <option value="recent">ìµœì‹ ìˆœ</option>
          <option value="rating">ë³„ì ìˆœ</option>
        </select>
      </div>
      <div id="reviews"></div>
    </section>

    <nav class="page-nav" aria-label="í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜">
      <a href="../index.html" class="page-link"><span class="page-number">1</span></a>
      <a href="schedule.html" class="page-link"><span class="page-number">2</span></a>
      <a href="library.html" class="page-link current" aria-current="page"><span class="page-number">3</span></a>
    </nav>
  </main>
  <footer class="site-footer">
    <small>Â© 2025 ExchangeBook</small>
  </footer>

  <script src="../js/bookData.js"></script>
  <script>
    function qs(k){return new URL(location.href).searchParams.get(k)}
    function renderStars(avg){
      const s = [];
      for(let i=1;i<=5;i++){
        const cls = i <= Math.round(avg) ? 'star' : 'star empty';
        s.push(`<svg class="${cls}" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.193-5.934 5.787 1.402 8.168L12 18.896 4.664 23.166l1.402-8.168L.132 9.211l8.2-1.193z"/></svg>`);
      }
      return `<div class="stars" aria-hidden="true">${s.join('')}</div>`
    }

    const id = qs('id');
    const book = getBookById?.(id);
    const coverEl = document.getElementById('cover');
    const titleEl = document.getElementById('title');
    const authorEl = document.getElementById('author');
    const ratingEl = document.getElementById('rating');
    const descEl = document.getElementById('desc');
    const tagsEl = document.getElementById('tags');
    const reviewsEl = document.getElementById('reviews');
    
    let reviewSortOrder = 'recent';

    function render(){
      if(!book){
        titleEl.textContent = 'ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        authorEl.textContent = '';
        coverEl.innerHTML = '<div class="placeholder">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë„ì„œ ëª©ë¡ì—ì„œ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>';
        return;
      }
      titleEl.textContent = book.title;
      authorEl.textContent = `${book.author}${book.publisher? ' Â· ' + book.publisher : ''}${book.year? ' Â· ' + book.year : ''}`;
      const avg = computeAverageRating(book);
      ratingEl.innerHTML = `${renderStars(avg)} <strong>${avg || '0.0'}</strong><span class="muted"> / 5</span>`;
      descEl.textContent = book.description || '';
      tagsEl.innerHTML = (book.tags||[]).map(t=>`<span class="pill">#${t}</span>`).join('');

      if(book.cover){
        coverEl.innerHTML = `<img src="${book.cover}" alt="${book.title} í‘œì§€">`;
      }else{
        coverEl.innerHTML = `<div class="placeholder">${book.title}\ní‘œì§€ ì´ë¯¸ì§€ê°€ ì—†ì–´ìš”</div>`;
      }

      // ë¦¬ë·° ë Œë”ë§
      const locals = getLocalReviews(book.id);
      let all = [...(book.reviews||[]), ...(locals||[])];
      
      // ì •ë ¬
      if(reviewSortOrder==='rating'){
        all.sort((a,b) => (b.rating||0) - (a.rating||0));
      }else{
        all.reverse(); // ìµœì‹ ìˆœ (ë‚˜ì¤‘ì— ì¶”ê°€ëœ ê²ƒì´ ìœ„ë¡œ)
      }
      
      if(!all.length){
        reviewsEl.innerHTML = '<p class="muted">ì•„ì§ í›„ê¸°ê°€ ì—†ì–´ìš”. ì²«ë²ˆì§¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
      }else{
        reviewsEl.innerHTML = all.map(r=>`<div class="review"><span class="who">${r.user||'ìµëª…'}</span> <span class="muted">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</span><div>${r.comment||''}</div></div>`).join('');
      }
    }

    render();
    
    // ë¦¬ë·° ì •ë ¬
    document.getElementById('reviewSort')?.addEventListener('change', e => {
      reviewSortOrder = e.target.value;
      render();
    });
    
    // ë§í¬ ë³µì‚¬
    document.getElementById('copyLinkBtn')?.addEventListener('click', () => {
      const url = location.href;
      navigator.clipboard.writeText(url).then(() => {
        alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }).catch(() => {
        alert('ë³µì‚¬ ì‹¤íŒ¨. ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      });
    });

    // í›„ê¸° ì‘ì„± ì²˜ë¦¬
    const form = document.getElementById('reviewForm');
    form?.addEventListener('submit', (e) => {
      e.preventDefault();
      if(!book) return;
      const fd = new FormData(form);
      const rating = Number(fd.get('rating')) || 3;
      const comment = String(fd.get('comment')||'').trim();
      const user = String(fd.get('user')||'').trim();
      if(!comment){
        alert('í›„ê¸°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      addLocalReview(book.id, { user: user||'ìµëª…', rating, comment });
      form.reset();
      render();
    });
  </script>
</body>
</html>
